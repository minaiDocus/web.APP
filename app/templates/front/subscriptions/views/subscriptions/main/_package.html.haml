- packages   = BillingMod::Configuration::LISTS
- my_package =  @customer.my_package
- count      = 0

.packages_list
  - packages.each do |package, infos|
    - class_derivation = ((count % 2) == 0) ? "derivationLeft" : "derivationRight"
    - count += 1
    - human_name = infos[:human_name].presence || nil
    - next if human_name.blank?
    - next if package.to_s == 'ido_micro'      && @customer.organization.uses_micro_plus?
    - next if package.to_s == 'ido_micro_plus' && !@customer.organization.uses_micro_plus?

    .package{ class: class_derivation }
      .row.box
        .col-sm-4.text-center
          .label-package.bold{ class: "label-#{package}" }= human_name
        .col-sm-4
          %span.semibold.description= infos[:description]
        .col-sm-2.text-end
          %label.price.bold
            = infos[:price]
            %span €/mois
        .col-sm-2.text-center
          = radio_button_tag 'package[name]', package.to_s, package.to_s == my_package.try(:name), class: "form-check-input radio-button main-option"
      .options.hide
        .row
          .col-sm-6.m-3
            - options = infos[:options].presence || []
            - options.each do |opt, value|
              - next if value != 'optional'
              - if opt.to_s == 'bank'
                .row.retriever-option
                  .col-md-10.form-group.no-margin
                    .form-check.form-check-inline{ data: { toggle: 'tooltip', placement: 'right' }}
                      %label.semibold Avec option  automate
                  .col-md-2.form-check.form-switch
                    %label.form-check-label Non
                    = check_box_tag "package[#{package.to_s}][bank]", opt.to_s, package.to_s == my_package.try(:name) && my_package.try(:bank_active), class: "form-check-input input_switch option_checkbox"
              - if opt.to_s == 'mail'
                .row.mail-option
                  .col-md-10.form-group.no-margin
                    .form-check.form-check-inline{ data: { toggle: 'tooltip', placement: 'right' }}
                      %label.semibold Avec option courrier
                  .col-md-2.form-check.form-switch
                    %label.form-check-label Non
                    = check_box_tag "package[#{package.to_s}][mail]", opt.to_s, package.to_s == my_package.try(:name) && my_package.try(:mail_active), class: "form-check-input option_checkbox input_switch"
                  
              - if opt.to_s == 'preassignment'
                .row.preassignmentt-option
                  .col-md-10.form-group.no-margin
                    .form-check.form-check-inline.pre_assignment
                      %label.semibold Pré-saisie comptable
                  .col-md-2.form-check.form-switch
                    %label.form-check-label.pre-assignment-state Oui
                    = check_box_tag "package[#{package.to_s}][preassignment]", opt.to_s, package.to_s == my_package.try(:name) && my_package.try(:preassignment_active), class: "form-check-input option_checkbox input_switch", data: { package: "mail_option" }
          .col-sm-5.m-3
            .input-journal-numbers
              .form-group
                = label_tag "package[#{package.to_s}][number_of_journals]", "Nombre de journaux", class: 'col-form-label required semibold'
                .select-container.no-padding.w-100.subscription_number_of_journals
                  = number_field_tag "package[#{package.to_s}][number_of_journals]", my_package.try(:journal_size) || 5, class: 'form-control special_input ', min: 5, max: 30, required: true, autofocus: true, pattern: '/^[0-9]+$/', placeholder: "5"
                  - if @customer.account_book_types.count > 5
                    &nbsp;
                    %span{id: 'err-msg-input-number'}
                    %div.clearfix
                      %i Supprimez un journal comptable avant de baisser cette option.

  %hr
  .form-group.row.w-100
    .col-md-6.text-start.ps-3
      - if current_user.is_admin
        .form-check.form-check-inline.me-5
          %label.form-check-label Appliquer tout de suite les options à la baisse ?
          = check_box_tag 'package[apply_now]', 'apply_now', false, class: 'form-check-input'
    .col-md-6.text-end
      %h6
        Prix du forfait avec les options sélectionnées :
        %b.total_price.bold 0,00 €

  .future_package
    - next_period  = CustomUtils.period_of(1.month.after)
    - next_package = @customer.package_of(next_period)

    - if next_package
      .text-center
        .alert.alert-warning.mb-3
          %h4.bold Votre abonnement du mois prochain :
          %hr 
        %span= next_package.to_json
